<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý sinh viên</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

<!-- ================= DANH SÁCH ================= -->
<div id="listView">
    <h3>DANH SÁCH SINH VIÊN</h3>

    <input type="text" id="search" class="form-control mb-3"
           placeholder="Tìm theo tên..." onkeyup="searchStudent()">

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>ID</th>
            <th>Tên</th>
            <th>Email</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody id="studentTable"></tbody>
    </table>

    <h4>THÊM / SỬA SINH VIÊN</h4>
    <input id="id" class="form-control mb-2" placeholder="ID (tự sinh)" readonly>
    <input id="name" class="form-control mb-2" placeholder="Tên">
    <input id="email" class="form-control mb-2" placeholder="Email">
    <input id="image" class="form-control mb-2" placeholder="Tên ảnh (vd: sv1.jpg)">

    <button class="btn btn-primary" onclick="addStudent()">Thêm</button>
    <button class="btn btn-warning" onclick="updateStudent()">Cập nhật</button>
</div>

<!-- ================= CHI TIẾT ================= -->
<div id="detailView" style="display:none;">
    <h3>CHI TIẾT SINH VIÊN</h3>

    <div class="card" style="max-width: 400px;">
        <img id="studentImage" class="card-img-top" alt="Ảnh sinh viên">

        <div class="card-body">
            <p><b>ID:</b> <span id="d-id"></span></p>
            <p><b>Tên:</b> <span id="d-name"></span></p>
            <p><b>Email:</b> <span id="d-email"></span></p>

            <button class="btn btn-secondary" onclick="backToList()">Quay lại</button>
        </div>
    </div>
</div>

<script>
const API = "http://localhost:8088/api/students";

const IMAGE_URL = "http://localhost:8088/images/";

const idInput = document.getElementById("id");
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const imageInput = document.getElementById("image");

function loadStudents() {
    fetch(API)
        .then(res => res.json())
        .then(data => {
            let html = "";
            data.forEach(s => {
                html += `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.email}</td>
                    <td>
                        <button class="btn btn-success btn-sm"
                            onclick="viewDetail(${s.id})">Xem</button>
                        <button class="btn btn-info btn-sm"
                            onclick="editStudent(${s.id}, '${s.name}', '${s.email}', '${s.image ?? ""}')">Sửa</button>
                        <button class="btn btn-danger btn-sm"
                            onclick="deleteStudent(${s.id})">Xóa</button>
                    </td>
                </tr>`;
            });
            studentTable.innerHTML = html;
        });
}

/* ========== THÊM (KHÔNG GỬI ID) ========== */
function addStudent() {
    const student = {
        name: nameInput.value,
        email: emailInput.value,
        image: imageInput.value
    };

    fetch(API, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(student)
    }).then(() => {
        clearForm();
        loadStudents();
    });
}

/* ========== SỬA (GÁN ĐÚNG ID) ========== */
function editStudent(sid, nameVal, emailVal, imageVal) {
    idInput.value = sid;
    nameInput.value = nameVal;
    emailInput.value = emailVal;
    imageInput.value = imageVal;
}

/* ========== CẬP NHẬT ========== */
function updateStudent() {
    if (!idInput.value) {
        alert("Chọn sinh viên cần sửa trước!");
        return;
    }

    const student = {
        name: nameInput.value,
        email: emailInput.value,
        image: imageInput.value
    };

    fetch(`${API}/${idInput.value}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(student)
    }).then(() => {
        clearForm();
        loadStudents();
    });
}

function deleteStudent(id) {
    if (!confirm("Xóa sinh viên này?")) return;

    fetch(`${API}/${id}`, { method: "DELETE" })
        .then(() => loadStudents());
}

/* ========== XEM CHI TIẾT ========== */
function viewDetail(id) {
    fetch(`${API}/${id}`)
        .then(res => res.json())
        .then(s => {
            listView.style.display = "none";
            detailView.style.display = "block";

            document.getElementById("d-id").innerText = s.id;
            document.getElementById("d-name").innerText = s.name;
            document.getElementById("d-email").innerText = s.email;
            studentImage.src = IMAGE_URL + (s.image ?? "default.png");
        });
}

function backToList() {
    detailView.style.display = "none";
    listView.style.display = "block";
}

function searchStudent() {
    fetch(`${API}/search?name=${search.value}`)
        .then(res => res.json())
        .then(data => {
            let html = "";
            data.forEach(s => {
                html += `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.email}</td>
                    <td>
                        <button class="btn btn-success btn-sm"
                            onclick="viewDetail(${s.id})">Xem</button>
                    </td>
                </tr>`;
            });
            studentTable.innerHTML = html;
        });
}

function clearForm() {
    idInput.value = "";
    nameInput.value = "";
    emailInput.value = "";
    imageInput.value = "";
}

loadStudents();
</script>

</body>
</html>
